{{#if user}}
<br>
<br>
<br>
<br>
<br>

<label for="p_scnts">
    <input type="text" id="p_scnt" size="20" name="p_scnt" value="" placeholder="Product Name" />
</label>
<label for="p_scnts">
    <input type="text" id="p_scnt" size="20" name="p_scnt" value="" placeholder="Category" />
</label>
<label for="p_scnts">
    <input type="text" id="p_scnt" size="20" name="p_scnt" value="" placeholder="Company" />
</label>
<br>
<br>
{{#each products}}
    <div class='row prod' cat={{Category.category_name}} url={{url}} id={{id}}>
        <div class="col-md-10 ">
            <div class='productshelf'>
            </div>
            <div class="row">
                <div class="col-md-5" >
                    <h3>{{short_desc}}</h3>
                </div>
                <div class="col-md-2">
                    <h5>{{Category.category_name}}</h5>
                </div>
            </div>
        </div> 
        <div class="col-md-1">
            <button id={{id}} class='btn btn-danger buy'>buy</button>
        </div>
        <div class="col-md-1">
            <h1>${{price}}</h1>
        </div>
        <br>
    </div>       
{{/each}}

<script class="javascript">
    $(".buy").on("click", function(event) {
        id = $(this).attr('id');
        console.log( $(this).attr('id'));

   var clickid = {
     id: $(this).attr('id')
   };

       // Send the PUT request.
    $.ajax("/add/click/", {
      type: "POST",
      data: clickid
    }).then(
      function() {
        console.log("adding click");
      }
    );
    });

    var ourItems;
    var product;
    var allOrders;

    var currentItem;
    var prodid;
    var allProducts=[];
    var userid;
    $(".buy").on("click", function (event) {
        prodid = $(this).attr('id');
        getProducts();
        function getProducts(){
            // Send the PUT request.
            $.ajax("/api/products", {
                type: "GET"
            }).then(
                function(data) {
                    allProducts = data;
                    //console.log(allProducts);
                findSpecificItem();
                }
            );
        };


        function findSpecificItem(){
            console.log("products came back...",allProducts);
            for( i = 0; i < allProducts.length; i++){
                console.log(allProducts[i].id.toString());
                console.log(prodid);
                if(allProducts[i].id.toString() === prodid){
                    currentItem = allProducts[i];
                    //console.log(currentItem);
                    
                }
            }
            setUpPostObj();
        };

        function setUpPostObj(){ 
            console.log('scoped',currentItem);
            $.ajax("/api/clicks", {
                type: "get"
            }).then(
                function (data) {
                    userid=data.user.id;
                    console.log('userid is right',userid);
                    buildPostObj();
                }
            );
        }

        function buildPostObj(){
            
            product = {
                id: currentItem.id,
                short_desc: currentItem.short_desc,
                category_id: currentItem.category_id,
                user_id: userid,
                price: currentItem.price,
                qty: 1
            };
            console.log('ready up for AJAX',product);
        postBuytoCart();
        };

        function postBuytoCart(){
            // Send the PUT request.
            $.ajax("/add/cart/", {
                type: "POST",
                data: product
            }).then(
                function () {
                    alert("added product to cart");

                }
            );
        }
    });
</script>
{{/if}}
{{#unless user}}
    <script>
        window.location.href = "/login";
    </script>
{{/unless}}
